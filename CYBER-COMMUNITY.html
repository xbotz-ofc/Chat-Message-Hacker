<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Chat Message Anonim</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: monospace;
      background: #000; color: #f00;
      display: flex; flex-direction: column;
      font-weight: bold; font-size: 18px;
    }
    h1, h2, h3 { text-align: center; }
    #login-container, #chat-container, #group-container {
      padding: 20px;
      margin: auto;
      width: 100%;
      max-width: 500px;
    }
    input, button, textarea {
      width: 100%;
      padding: 12px;
      margin: 6px 0;
      border: none;
      border-radius: 5px;
      background: #111;
      color: #f00;
      font-weight: bold;
      font-size: 17px;
    }
    button:hover { background: #222; cursor: pointer; }
    #chat-container, #group-container { display: none; }

    /* Bubble Message Styles */
    #messages {
      background: #111;
      padding: 10px;
      height: 400px;
      overflow-y: auto;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    .msg { 
      margin: 15px 0;
      position: relative;
      padding-left: 15px;
    }
    .msg::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: #f00;
    }
    .msg-content {
      background: #222;
      padding: 12px 15px;
      border-radius: 5px;
      display: inline-block;
      max-width: 80%;
      position: relative;
      word-wrap: break-word;
    }
    .msg.you { 
      text-align: right;
      padding-right: 15px;
      padding-left: 0;
    }
    .msg.you .msg-content {
      background: #300;
      color: #0f0;
    }
    .msg.you::before {
      left: auto;
      right: 0;
      background: #0f0;
    }
    .msg.other { 
      text-align: left;
    }
    
    /* Media Styles */
    .media-container {
      margin-top: 5px;
      max-width: 100%;
    }
    .media-container img {
      max-width: 100%;
      max-height: 200px;
      border-radius: 5px;
    }
    .media-container video {
      max-width: 100%;
      max-height: 200px;
      background: #000;
      border-radius: 5px;
    }
    .media-container audio {
      width: 100%;
      background: #111;
      padding: 5px;
      border-radius: 5px;
      outline: 1px solid #f00;
    }
    .media-file-info {
      font-size: 14px;
      margin-top: 5px;
      color: #f00;
    }

    /* Input Container */
    #input-container {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-top: 10px;
      background: #000;
      padding: 10px;
      border-radius: 5px;
    }
    
    #input-row {
      display: flex;
      gap: 5px;
    }
    
    #chat-input {
      flex: 1;
      padding: 12px;
    }
    
    #btn-send {
      width: auto;
      padding: 12px 20px;
      background: #f00;
      color: white;
    }

    /* File Input */
    #file-input-container {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    #file-input-label {
      background: #111;
      color: #f00;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    #file-input {
      display: none;
    }
    #file-name {
      font-size: 14px;
      color: #f00;
    }

    /* User List Styles */
    #user-list-container {
      margin-bottom: 10px;
      background: #111;
      padding: 10px;
      border-radius: 5px;
    }
    
    #user-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }
    
    #user-list-toggle {
      background: #333;
      padding: 5px 10px;
      font-size: 14px;
      border-radius: 5px;
      cursor: pointer;
    }
    
    #user-list-toggle:hover {
      background: #444;
    }
    
    #user-search-container, #group-search-container {
      display: flex;
      gap: 5px;
      margin-bottom: 5px;
    }
    
    #user-search, #group-search {
      flex: 1;
      padding: 8px;
      font-size: 14px;
    }
    
    #btn-clear-search, #btn-clear-group-search {
      width: auto;
      padding: 8px 12px;
      background: #333;
      color: #f00;
    }
    
    #user-list, #group-users, #group-list {
      margin-top: 5px;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    
    #user-list button, #group-users button, #group-list button {
      flex: 1;
      min-width: 100px;
      background: #111;
      color: #f00;
      padding: 8px;
      font-size: 14px;
    }
    
    .online::after { content: " ‚óè"; color: #0f0; }
    .offline::after { content: " ‚óè"; color: #444; }
    .active-chat { background: #333 !important; }
    .hidden { display: none !important; }

    /* Group Request Box */
    #group-requests-box {
      margin-top: 20px;
      border: 1px solid #f00;
      padding: 10px;
      border-radius: 5px;
      display: none;
    }

    /* Group Controls */
    #top-group-controls {
      position: sticky;
      top: 0;
      background: #000;
      z-index: 2;
      padding-bottom: 10px;
    }
    
    /* Chat Controls */
    #chat-controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    #btn-delete-chat {
      background: #f00;
      color: white;
      padding: 8px 12px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="login-container">
    <h1>CYBER COMMUNITY</h1>
    <input id="username" placeholder="Username">
    <input id="password" type="password" placeholder="Password">
    <button id="btn-register">Daftar</button>
    <button id="btn-login">Login</button>
    <p id="login-msg" style="color:red;"></p>
  </div>

  <div id="chat-container">
    <h2>Cyber Community By Xrans</h2>
    <button id="toggle-group-btn" onclick="toggleGroupChat()">Tampilkan Grup Chat</button>
    <div id="current-chat-info">Sedang chat dengan: GLOBAL</div>
    
    <!-- User List Container with Search and Toggle -->
    <div id="user-list-container">
      <div id="user-list-header">
        <h3 style="margin: 0;">Daftar Pengguna</h3>
        <button id="user-list-toggle" onclick="toggleUserList()">‚ñº Sembunyikan</button>
      </div>
      
      <div id="user-search-container">
        <input id="user-search" type="text" placeholder="Cari pengguna..." oninput="filterUserList()">
        <button id="btn-clear-search" onclick="clearUserSearch()">X</button>
      </div>
      
      <div id="user-list"></div>
    </div>
    
    <!-- Group List with Search -->
    <div id="group-list-container" style="display:none">
      <div id="group-search-container">
        <input id="group-search" type="text" placeholder="Cari grup..." oninput="filterGroupList()">
        <button id="btn-clear-group-search" onclick="clearGroupSearch()">X</button>
      </div>
      <div id="group-list"></div>
    </div>
    
    <div id="chat-controls">
      <button id="btn-delete-chat" onclick="deleteCurrentChat()">Hapus Riwayat Chat Ini</button>
    </div>
    
    <div id="messages"></div>
    
    <div id="input-container">
      <div id="input-row">
        <input id="chat-input" type="text" placeholder="Ketik pesan di sini...">
        <button id="btn-send">Kirim</button>
      </div>
      
      <div id="file-input-container">
        <label id="file-input-label" for="file-input">üìÅ Pilih File</label>
        <span id="file-name"></span>
        <input type="file" id="file-input" accept="image/*,video/*,audio/*">
      </div>
    </div>
    
    <button onclick="switchToGroup()">Kelola Grup</button>
    <button onclick="toggleGroupRequests()">Lihat Permintaan Grup</button>
    <div id="group-requests-box"></div>
  </div>

  <div id="group-container">
    <div id="top-group-controls">
      <input id="group-name" placeholder="Nama Grup">
      <button id="btn-create-group">Buat Grup</button>
      <button onclick="switchToChat()">‚Üê Kembali ke Chat</button>
    </div>
    <div id="group-users"></div>
  </div>

  <script>
    const config = {
      apiKey: "AIzaSyA_QzbdScTX2dLdu_VchsPH1JL-1tn3RcI",
      authDomain: "chat-message-fcf6f.firebaseapp.com",
      databaseURL: "https://chat-message-fcf6f-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "chat-message-fcf6f",
      storageBucket: "chat-message-fcf6f.appspot.com",
      messagingSenderId: "137162503818",
      appId: "1:137162503818:web:2c782da021738705e99f73"
    };
    firebase.initializeApp(config);
    const db = firebase.database();

    let currentUser = null;
    let chatWith = "ALL";
    let showGroupChat = false;
    let showUserList = true;
    let currentChatType = "public";
    let chatHistory = {
      public: [],
      private: {},
      group: {}
    };

    // DOM Elements
    const loginBox = document.getElementById('login-container');
    const chatBox = document.getElementById('chat-container');
    const groupBox = document.getElementById('group-container');
    const msgBox = document.getElementById('login-msg');
    const userEl = document.getElementById('username');
    const passEl = document.getElementById('password');
    const msgArea = document.getElementById('messages');
    const userList = document.getElementById('user-list');
    const groupList = document.getElementById('group-list');
    const chatInput = document.getElementById('chat-input');
    const fileInput = document.getElementById('file-input');
    const fileName = document.getElementById('file-name');
    const groupReqBox = document.getElementById('group-requests-box');
    const groupUsers = document.getElementById('group-users');
    const toggleGroupBtn = document.getElementById('toggle-group-btn');
    const currentChatInfo = document.getElementById('current-chat-info');
    const userSearch = document.getElementById('user-search');
    const groupSearch = document.getElementById('group-search');
    const userListToggle = document.getElementById('user-list-toggle');
    const userListContainer = document.getElementById('user-list-container').querySelector('#user-list');
    const groupListContainer = document.getElementById('group-list-container');

    // Initialize the app
    document.getElementById('btn-register').onclick = registerUser;
    document.getElementById('btn-login').onclick = loginUser;
    document.getElementById('btn-send').onclick = sendMessage;
    fileInput.addEventListener('change', handleFileUpload);
    chatInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') sendMessage();
    });

    function registerUser() {
      const u = userEl.value, p = passEl.value;
      if (!u || !p) return showLoginMessage("Isi lengkap.", "error");
      
      db.ref("users/" + u).get().then(snap => {
        if (snap.exists()) return showLoginMessage("Username sudah dipakai.", "error");
        
        db.ref("users/" + u).set({ 
          password: p, 
          online: true,
          lastSeen: Date.now()
        });
        showLoginMessage("Berhasil daftar, login sekarang.", "success");
      });
    }

    function loginUser() {
      const u = userEl.value, p = passEl.value;
      db.ref("users/" + u).get().then(snap => {
        if (!snap.exists() || snap.val().password !== p) {
          return showLoginMessage("Login gagal.", "error");
        }
        
        currentUser = u;
        db.ref("users/" + u).update({ 
          online: true,
          lastSeen: Date.now()
        });
        
        loginBox.style.display = "none";
        chatBox.style.display = "block";
        initChat();
        loadChatHistory();
      });
    }

    function initChat() {
      // Load users
      db.ref("users").on("value", snap => {
        userList.innerHTML = '';
        groupUsers.innerHTML = '';
        
        // Public chat button
        const publicBtn = document.createElement('button');
        publicBtn.textContent = "GLOBAL";
        publicBtn.className = chatWith === "ALL" ? "active-chat" : "";
        publicBtn.onclick = () => {
          chatWith = "ALL";
          currentChatType = "public";
          updateChatInfo();
          displayChatHistory();
        };
        userList.appendChild(publicBtn);
        
        // Other users
        snap.forEach(child => {
          const u = child.key;
          if (u === currentUser) return;
          const status = child.val().online ? 'online' : 'offline';
          
          // Private chat button
          const btn = document.createElement('button');
          btn.textContent = u;
          btn.className = status + (chatWith === u ? " active-chat" : "");
          btn.onclick = () => {
            chatWith = u;
            currentChatType = "private";
            updateChatInfo();
            displayChatHistory();
          };
          userList.appendChild(btn);

          // Group invite button
          const inviteBtn = document.createElement('button');
          inviteBtn.textContent = `Undang ${u}`;
          inviteBtn.onclick = () => inviteToGroup(u);
          groupUsers.appendChild(inviteBtn);
        });
      });

      // Load groups
      db.ref("groups").on("value", snap => {
        groupList.innerHTML = '';
        snap.forEach(child => {
          const groupName = child.key;
          if (child.val().members && child.val().members[currentUser]) {
            const btn = document.createElement('button');
            btn.textContent = groupName;
            btn.className = chatWith === "GROUP_"+groupName ? "active-chat" : "";
            btn.onclick = () => {
              chatWith = "GROUP_"+groupName;
              currentChatType = "group";
              updateChatInfo();
              displayChatHistory();
            };
            groupList.appendChild(btn);
          }
        });
      });

      // Listen for new messages
      db.ref("messages").on("child_added", s => {
        const m = s.val();
        saveMessageToHistory(m);
        
        if (shouldDisplayMessage(m)) {
          displayMessage(m);
        }
      });

      // Listen for group requests
      db.ref("group_requests/" + currentUser).on("child_added", s => {
        const groupName = s.key;
        const div = document.createElement('div');
        div.innerHTML = `Undangan ke grup <b>${groupName}</b> 
          <button onclick="acceptGroup('${groupName}')">Gabung</button>`;
        groupReqBox.appendChild(div);
      });
      
      updateChatInfo();
    }

    function handleFileUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      fileName.textContent = file.name;
      
      if (file.type.startsWith('audio/')) {
        // Special handling for audio files
        const audioURL = URL.createObjectURL(file);
        const content = `
          <div class="media-container">
            <audio controls>
              <source src="${audioURL}" type="${file.type}">
              Browser tidak mendukung audio
            </audio>
            <div class="media-file-info">${file.name}</div>
          </div>`;
        
        sendMediaMessage(content, 'audio');
        fileName.textContent = '';
        fileInput.value = '';
      } 
      else {
        // Handle other file types (images, videos)
        const reader = new FileReader();
        reader.onload = () => {
          let content = '';
          let type = '';
          
          if (file.type.startsWith('image/')) {
            content = `<div class="media-container"><img src="${reader.result}" style="max-width:100%;"></div>`;
            type = 'image';
          } else if (file.type.startsWith('video/')) {
            content = `<div class="media-container"><video controls style="max-width:100%;"><source src="${reader.result}" type="${file.type}"></video></div>`;
            type = 'video';
          } else {
            content = `<a href="${reader.result}" download="${file.name}">Unduh file: ${file.name}</a>`;
            type = 'file';
          }
          
          sendMediaMessage(content, type);
          fileName.textContent = '';
          fileInput.value = '';
        };
        reader.readAsDataURL(file);
      }
    }

    function sendMediaMessage(content, type) {
      let recipient = chatWith;
      if (currentChatType === "group") {
        recipient = "GROUP_" + chatWith.substring(6);
      }
      
      const newMessage = {
        from: currentUser,
        to: recipient,
        text: content,
        type: type,
        ts: Date.now()
      };
      
      db.ref("messages").push(newMessage);
      saveMessageToHistory(newMessage);
    }

    function sendMessage() {
      const text = chatInput.value.trim();
      if (!text) return;
      
      let recipient = chatWith;
      if (currentChatType === "group") {
        recipient = "GROUP_" + chatWith.substring(6);
      }
      
      const newMessage = {
        from: currentUser, 
        to: recipient, 
        text: text,
        ts: Date.now() 
      };
      
      db.ref("messages").push(newMessage);
      saveMessageToHistory(newMessage);
      chatInput.value = '';
      chatInput.focus();
    }

    function displayMessage({from, to, text, ts, type}) {
      const d = new Date(ts);
      const time = d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      
      const div = document.createElement('div');
      div.className = "msg " + (from === currentUser ? "you" : "other");
      
      const msgContent = document.createElement('div');
      msgContent.className = 'msg-content';
      
      // Handle different message types
      if (type === 'audio' || type === 'image' || type === 'video') {
        msgContent.innerHTML = text;
      } else {
        msgContent.textContent = text;
      }
      
      // Add sender info
      const msgInfo = document.createElement('div');
      msgInfo.className = 'msg-info';
      msgInfo.innerHTML = `<b>${from}</b> @${time}`;
      
      div.appendChild(msgContent);
      div.appendChild(msgInfo);
      msgArea.appendChild(div);
      msgArea.scrollTop = msgArea.scrollHeight;
    }

    function saveMessageToHistory(m) {
      if (m.to === "ALL") {
        chatHistory.public.push(m);
      } else if (m.to.startsWith("GROUP_")) {
        const groupName = m.to.substring(6);
        if (!chatHistory.group[groupName]) chatHistory.group[groupName] = [];
        chatHistory.group[groupName].push(m);
      } else {
        const otherUser = m.from === currentUser ? m.to : m.from;
        if (!chatHistory.private[otherUser]) chatHistory.private[otherUser] = [];
        chatHistory.private[otherUser].push(m);
      }
    }

    function loadChatHistory() {
      db.ref("messages").once("value").then(snap => {
        chatHistory = { public: [], private: {}, group: {} };
        snap.forEach(child => saveMessageToHistory(child.val()));
        displayChatHistory();
      });
    }

    function displayChatHistory() {
      msgArea.innerHTML = '';
      
      if (currentChatType === "public") {
        chatHistory.public.forEach(m => displayMessage(m));
      } else if (currentChatType === "private") {
        if (chatHistory.private[chatWith]) {
          chatHistory.private[chatWith].forEach(m => displayMessage(m));
        }
      } else if (currentChatType === "group") {
        const groupName = chatWith.substring(6);
        if (chatHistory.group[groupName]) {
          chatHistory.group[groupName].forEach(m => displayMessage(m));
        }
      }
    }

    function shouldDisplayMessage(m) {
      if (currentChatType === "public" && m.to === "ALL") return true;
      if (currentChatType === "private" && 
          ((m.to === chatWith && m.from === currentUser) || 
           (m.from === chatWith && m.to === currentUser))) return true;
      if (currentChatType === "group" && m.to === chatWith) return true;
      return false;
    }

    function updateChatInfo() {
      let chatName = chatWith;
      if (chatWith === "ALL") chatName = "GLOBAL";
      else if (chatWith.startsWith("GROUP_")) chatName = chatWith.substring(6);
      
      currentChatInfo.textContent = `Sedang chat dengan: ${chatName}`;
      
      // Update active chat buttons
      document.querySelectorAll('#user-list button, #group-list button').forEach(btn => {
        btn.classList.remove('active-chat');
      });
      
      if (chatWith === "ALL") {
        document.querySelector('#user-list button:first-child').classList.add('active-chat');
      } else if (chatWith.startsWith("GROUP_")) {
        const groupName = chatWith.substring(6);
        document.querySelectorAll('#group-list button').forEach(btn => {
          if (btn.textContent === groupName) btn.classList.add('active-chat');
        });
      } else {
        document.querySelectorAll('#user-list button').forEach(btn => {
          if (btn.textContent === chatWith) btn.classList.add('active-chat');
        });
      }
    }

    function toggleGroupChat() {
      showGroupChat = !showGroupChat;
      groupListContainer.style.display = showGroupChat ? "block" : "none";
      toggleGroupBtn.textContent = showGroupChat ? "Sembunyikan Grup Chat" : "Tampilkan Grup Chat";
    }

    function toggleUserList() {
      showUserList = !showUserList;
      userListContainer.style.display = showUserList ? "flex" : "none";
      userListToggle.textContent = showUserList ? "‚ñº Sembunyikan" : "‚ñ≤ Tampilkan";
    }

    function filterUserList() {
      const searchTerm = userSearch.value.toLowerCase();
      const buttons = document.querySelectorAll('#user-list button');
      
      buttons.forEach(button => {
        const text = button.textContent.toLowerCase();
        if (text.includes(searchTerm) || searchTerm === '') {
          button.classList.remove('hidden');
        } else {
          button.classList.add('hidden');
        }
      });
    }

    function filterGroupList() {
      const searchTerm = groupSearch.value.toLowerCase();
      const buttons = document.querySelectorAll('#group-list button');
      
      buttons.forEach(button => {
        const text = button.textContent.toLowerCase();
        if (text.includes(searchTerm) || searchTerm === '') {
          button.classList.remove('hidden');
        } else {
          button.classList.add('hidden');
        }
      });
    }

    function clearUserSearch() {
      userSearch.value = '';
      filterUserList();
    }

    function clearGroupSearch() {
      groupSearch.value = '';
      filterGroupList();
    }

    function deleteCurrentChat() {
      if (currentChatType === "public") {
        chatHistory.public = [];
      } else if (currentChatType === "private") {
        if (chatHistory.private[chatWith]) delete chatHistory.private[chatWith];
      } else if (currentChatType === "group") {
        const groupName = chatWith.substring(6);
        if (chatHistory.group[groupName]) delete chatHistory.group[groupName];
      }
      
      // Delete from Firebase
      db.ref("messages").once("value").then(snap => {
        snap.forEach(child => {
          const m = child.val();
          if ((currentChatType === "public" && m.to === "ALL" && m.from === currentUser) ||
              (currentChatType === "private" && 
               ((m.to === chatWith && m.from === currentUser) || 
                (m.from === chatWith && m.to === currentUser))) ||
              (currentChatType === "group" && m.to === chatWith && m.from === currentUser)) {
            db.ref("messages/" + child.key).remove();
          }
        });
      });
      
      displayChatHistory();
      alert("Riwayat chat telah dihapus");
    }

    function inviteToGroup(user) {
      const group = document.getElementById('group-name').value;
      if (!group) return alert("Masukkan nama grup dulu.");
      db.ref("group_requests/" + user + "/" + group).set({ from: currentUser });
      alert("Undangan dikirim.");
    }

    function acceptGroup(group) {
      db.ref("groups/" + group + "/members/" + currentUser).set(true);
      db.ref("group_requests/" + currentUser + "/" + group).remove();
      alert("Bergabung ke grup " + group);
    }

    function switchToGroup() {
      chatBox.style.display = "none";
      groupBox.style.display = "block";
    }

    function switchToChat() {
      chatBox.style.display = "block";
      groupBox.style.display = "none";
    }

    function toggleGroupRequests() {
      groupReqBox.style.display = groupReqBox.style.display === 'none' ? 'block' : 'none';
    }

    function showLoginMessage(msg, type) {
      msgBox.textContent = msg;
      msgBox.style.color = type === "error" ? "red" : "#0f0";
    }

    window.addEventListener('beforeunload', () => {
      if (currentUser) {
        db.ref("users/" + currentUser).update({ 
          online: false,
          lastSeen: Date.now()
        });
      }
    });
  </script>
</body>
</html>