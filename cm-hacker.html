<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Chat Message Hacker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: monospace;
      background: #000; color: #f00;
      display: flex; flex-direction: column;
      font-weight: bold; font-size: 18px;
    }
    h1, h2, h3 { text-align: center; }
    #login-container, #chat-container, #group-container {
      padding: 20px;
      margin: auto;
      width: 100%;
      max-width: 500px;
    }
    input, button, textarea {
      width: 100%;
      padding: 12px;
      margin: 6px 0;
      border: none;
      border-radius: 5px;
      background: #111;
      color: #f00;
      font-weight: bold;
      font-size: 17px;
    }
    button:hover { background: #222; cursor: pointer; }
    #chat-container, #group-container { display: none; }

    #messages {
      background: #111;
      padding: 10px;
      height: 300px;
      overflow-y: auto;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    .msg { margin: 6px 0; }
    .msg.you { text-align: right; color: #0f0; }
    .msg.other { text-align: left; color: #f00; }

    #input-container {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-top: 10px;
      background: #000;
      padding: 10px;
      border-radius: 5px;
    }
    
    #input-row {
      display: flex;
      gap: 5px;
    }
    
    #chat-input {
      flex: 1;
      padding: 12px;
    }
    
    #btn-send {
      width: auto;
      padding: 12px 20px;
      background: #f00;
      color: white;
    }

    #user-list, #group-users, #group-list {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    
    #user-list button, #group-users button, #group-list button {
      flex: 1;
      min-width: 100px;
      background: #111;
      color: #f00;
    }
    
    .online::after { content: " ●"; color: #0f0; }
    .offline::after { content: " ●"; color: #444; }
    .active-chat { background: #333 !important; }

    #group-requests-box {
      margin-top: 20px;
      border: 1px solid #f00;
      padding: 10px;
      border-radius: 5px;
      display: none;
    }

    #top-group-controls {
      position: sticky;
      top: 0;
      background: #000;
      z-index: 2;
      padding-bottom: 10px;
    }
    
    #toggle-group-btn {
      background: #333;
      margin-bottom: 10px;
    }
    
    #current-chat-info {
      background: #111;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      text-align: center;
    }
    
    #file-input {
      margin-top: 5px;
    }
    
    #chat-controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    #btn-delete-chat {
      background: #f00;
      color: white;
      padding: 8px 12px;
      font-size: 14px;
    }

    /* Styles for user list controls */
    #user-list-container {
      margin-bottom: 10px;
      background: #111;
      padding: 10px;
      border-radius: 5px;
    }
    
    #user-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }
    
    #user-list-toggle {
      background: #333;
      padding: 5px 10px;
      font-size: 14px;
      border-radius: 5px;
      cursor: pointer;
    }
    
    #user-list-toggle:hover {
      background: #444;
    }
    
    #user-search-container {
      display: flex;
      gap: 5px;
      margin-top: 5px;
    }
    
    #user-search {
      flex: 1;
      padding: 8px;
      font-size: 14px;
    }
    
    #btn-clear-search {
      width: auto;
      padding: 8px 12px;
      background: #333;
      color: #f00;
    }
    
    .hidden-user {
      display: none !important;
    }
    
    .collapsed {
      display: none;
    }
  </style>
</head>
<body>
  <div id="login-container">
    <h1>Chat Message Hacker</h1>
    <input id="username" placeholder="Username">
    <input id="password" type="password" placeholder="Password">
    <button id="btn-register">Daftar</button>
    <button id="btn-login">Login</button>
    <p id="login-msg" style="color:red;"></p>
  </div>

  <div id="chat-container">
    <h2>Chat Message Anonim Only Hacker By Xrans</h2>
    <button id="toggle-group-btn" onclick="toggleGroupChat()">Tampilkan Grup Chat</button>
    <div id="current-chat-info">Sedang chat dengan: SEMUA</div>
    
    <!-- User List Container with Toggle and Search -->
    <div id="user-list-container">
      <div id="user-list-header">
        <h3 style="margin: 0;">Daftar Pengguna</h3>
        <button id="user-list-toggle" onclick="toggleUserList()">▼ Sembunyikan</button>
      </div>
      
      <div id="user-search-container">
        <input id="user-search" type="text" placeholder="Cari pengguna..." oninput="filterUserList()">
        <button id="btn-clear-search" onclick="clearUserSearch()">X</button>
      </div>
      
      <div id="user-list"></div>
    </div>
    
    <div id="group-list" style="display:none"></div>
    
    <div id="chat-controls">
      <button id="btn-delete-chat" onclick="deleteCurrentChat()">Hapus Riwayat Chat Ini</button>
    </div>
    
    <div id="messages"></div>
    
    <div id="input-container">
      <div id="input-row">
        <input id="chat-input" type="text" placeholder="Ketik pesan di sini...">
        <button id="btn-send">Kirim</button>
      </div>
      <input type="file" id="file-input">
    </div>
    
    <button onclick="switchToGroup()">Kelola Grup</button>
    <button onclick="toggleGroupRequests()">Lihat Permintaan Grup</button>
    <div id="group-requests-box"></div>
  </div>

  <div id="group-container">
    <div id="top-group-controls">
      <input id="group-name" placeholder="Nama Grup">
      <button id="btn-create-group">Buat Grup</button>
      <button onclick="switchToChat()">← Kembali ke Chat</button>
    </div>
    <div id="group-users"></div>
  </div>

  <script>
    const config = {
      apiKey: "AIzaSyA_QzbdScTX2dLdu_VchsPH1JL-1tn3RcI",
      authDomain: "chat-message-fcf6f.firebaseapp.com",
      databaseURL: "https://chat-message-fcf6f-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "chat-message-fcf6f",
      storageBucket: "chat-message-fcf6f.appspot.com",
      messagingSenderId: "137162503818",
      appId: "1:137162503818:web:2c782da021738705e99f73"
    };
    firebase.initializeApp(config);
    const db = firebase.database();

    let currentUser = null;
    let chatWith = "ALL";
    let showGroupChat = false;
    let showUserList = true;
    let currentChatType = "public";
    let chatHistory = {
      public: [],
      private: {},
      group: {}
    };

    const loginBox = document.getElementById('login-container');
    const chatBox = document.getElementById('chat-container');
    const groupBox = document.getElementById('group-container');

    const msgBox = document.getElementById('login-msg');
    const userEl = document.getElementById('username');
    const passEl = document.getElementById('password');
    const msgArea = document.getElementById('messages');
    const userList = document.getElementById('user-list');
    const groupList = document.getElementById('group-list');
    const chatInput = document.getElementById('chat-input');
    const groupReqBox = document.getElementById('group-requests-box');
    const groupUsers = document.getElementById('group-users');
    const toggleGroupBtn = document.getElementById('toggle-group-btn');
    const currentChatInfo = document.getElementById('current-chat-info');
    const userSearch = document.getElementById('user-search');
    const userListToggle = document.getElementById('user-list-toggle');

    // Fungsi untuk toggle user list
    function toggleUserList() {
      showUserList = !showUserList;
      if (showUserList) {
        userList.classList.remove('collapsed');
        userListToggle.textContent = "▼ Sembunyikan";
      } else {
        userList.classList.add('collapsed');
        userListToggle.textContent = "▲ Tampilkan";
      }
    }

    // Fungsi untuk memfilter user list
    function filterUserList() {
      const searchTerm = userSearch.value.toLowerCase();
      const userButtons = document.querySelectorAll('#user-list button');
      
      userButtons.forEach(button => {
        const username = button.textContent.toLowerCase();
        if (username.includes(searchTerm) || searchTerm === '') {
          button.classList.remove('hidden-user');
        } else {
          button.classList.add('hidden-user');
        }
      });
    }

    // Fungsi untuk membersihkan pencarian
    function clearUserSearch() {
      userSearch.value = '';
      filterUserList();
    }

    // Fungsi toggle group chat
    function toggleGroupChat() {
      showGroupChat = !showGroupChat;
      groupList.style.display = showGroupChat ? "flex" : "none";
      toggleGroupBtn.textContent = showGroupChat ? "Sembunyikan Grup Chat" : "Tampilkan Grup Chat";
    }

    document.getElementById('btn-register').onclick = () => {
      const u = userEl.value, p = passEl.value;
      if (!u || !p) return msgBox.textContent = "Isi lengkap.";
      db.ref("users/" + u).get().then(snap => {
        if (snap.exists()) return msgBox.textContent = "Username sudah dipakai.";
        db.ref("users/" + u).set({ password: p, online: true });
        msgBox.textContent = "Berhasil daftar, login sekarang.";
      });
    };

    document.getElementById('btn-login').onclick = () => {
      const u = userEl.value, p = passEl.value;
      db.ref("users/" + u).get().then(snap => {
        if (!snap.exists() || snap.val().password !== p) {
          msgBox.textContent = "Login gagal.";
        } else {
          currentUser = u;
          db.ref("users/" + u).update({ online: true });
          loginBox.style.display = "none";
          chatBox.style.display = "block";
          initChat();
          loadChatHistory();
        }
      });
    };

    function initChat() {
      // Load users
      db.ref("users").on("value", snap => {
        userList.innerHTML = '';
        groupUsers.innerHTML = '';
        
        // Tombol chat publik
        const publicBtn = document.createElement('button');
        publicBtn.textContent = "SEMUA";
        publicBtn.className = chatWith === "ALL" ? "active-chat" : "";
        publicBtn.onclick = () => {
          chatWith = "ALL";
          currentChatType = "public";
          updateChatInfo();
          displayChatHistory();
        };
        userList.appendChild(publicBtn);
        
        snap.forEach(child => {
          const u = child.key;
          if (u === currentUser) return;
          const status = child.val().online ? 'online' : 'offline';
          
          // Tombol untuk chat privat
          const btn = document.createElement('button');
          btn.textContent = u;
          btn.className = status + (chatWith === u ? " active-chat" : "");
          btn.onclick = () => {
            chatWith = u;
            currentChatType = "private";
            updateChatInfo();
            displayChatHistory();
          };
          userList.appendChild(btn);

          // Tombol untuk mengundang ke grup
          const inviteBtn = document.createElement('button');
          inviteBtn.textContent = `Undang ${u}`;
          inviteBtn.onclick = () => inviteToGroup(u);
          groupUsers.appendChild(inviteBtn);
        });
      });

      // Load groups
      db.ref("groups").on("value", snap => {
        groupList.innerHTML = '';
        snap.forEach(child => {
          const groupName = child.key;
          if (child.val().members && child.val().members[currentUser]) {
            const btn = document.createElement('button');
            btn.textContent = groupName;
            btn.className = chatWith === "GROUP_"+groupName ? "active-chat" : "";
            btn.onclick = () => {
              chatWith = "GROUP_"+groupName;
              currentChatType = "group";
              updateChatInfo();
              displayChatHistory();
            };
            groupList.appendChild(btn);
          }
        });
      });

      // Listen for new messages
      db.ref("messages").on("child_added", s => {
        const m = s.val();
        saveMessageToHistory(m);
        
        // Tampilkan pesan jika relevan dengan chat aktif
        if (shouldDisplayMessage(m)) {
          showMessage(m);
        }
      });

      // Listen for group requests
      db.ref("group_requests/" + currentUser).on("child_added", s => {
        const groupName = s.key;
        const div = document.createElement('div');
        div.innerHTML = `Undangan ke grup <b>${groupName}</b> 
          <button onclick="acceptGroup('${groupName}')">Gabung</button>`;
        groupReqBox.appendChild(div);
      });
      
      updateChatInfo();
      
      // Handle enter key untuk mengirim pesan
      chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });
    }

    function shouldDisplayMessage(m) {
      if (currentChatType === "public" && m.to === "ALL") return true;
      if (currentChatType === "private" && 
          ((m.to === chatWith && m.from === currentUser) || 
           (m.from === chatWith && m.to === currentUser))) return true;
      if (currentChatType === "group" && m.to === chatWith) return true;
      return false;
    }

    function saveMessageToHistory(m) {
      if (m.to === "ALL") {
        // Pesan publik
        chatHistory.public.push(m);
      } else if (m.to.startsWith("GROUP_")) {
        // Pesan grup
        const groupName = m.to.substring(6);
        if (!chatHistory.group[groupName]) {
          chatHistory.group[groupName] = [];
        }
        chatHistory.group[groupName].push(m);
      } else {
        // Pesan privat
        const otherUser = m.from === currentUser ? m.to : m.from;
        if (!chatHistory.private[otherUser]) {
          chatHistory.private[otherUser] = [];
        }
        chatHistory.private[otherUser].push(m);
      }
    }

    function loadChatHistory() {
      db.ref("messages").once("value").then(snap => {
        chatHistory = {
          public: [],
          private: {},
          group: {}
        };
        
        snap.forEach(child => {
          const m = child.val();
          saveMessageToHistory(m);
        });
        
        displayChatHistory();
      });
    }

    function displayChatHistory() {
      msgArea.innerHTML = '';
      
      if (currentChatType === "public") {
        chatHistory.public.forEach(m => showMessage(m));
      } else if (currentChatType === "private") {
        if (chatHistory.private[chatWith]) {
          chatHistory.private[chatWith].forEach(m => showMessage(m));
        }
      } else if (currentChatType === "group") {
        const groupName = chatWith.substring(6);
        if (chatHistory.group[groupName]) {
          chatHistory.group[groupName].forEach(m => showMessage(m));
        }
      }
    }

    function updateChatInfo() {
      let chatName = chatWith;
      if (chatWith === "ALL") chatName = "SEMUA";
      else if (chatWith.startsWith("GROUP_")) chatName = chatWith.substring(6);
      
      currentChatInfo.textContent = `Sedang chat dengan: ${chatName}`;
      
      // Update active chat buttons
      document.querySelectorAll('#user-list button, #group-list button').forEach(btn => {
        btn.classList.remove('active-chat');
      });
      
      if (chatWith === "ALL") {
        document.querySelector('#user-list button:first-child').classList.add('active-chat');
      } else if (chatWith.startsWith("GROUP_")) {
        const groupName = chatWith.substring(6);
        document.querySelectorAll('#group-list button').forEach(btn => {
          if (btn.textContent === groupName) {
            btn.classList.add('active-chat');
          }
        });
      } else {
        document.querySelectorAll('#user-list button').forEach(btn => {
          if (btn.textContent === chatWith) {
            btn.classList.add('active-chat');
          }
        });
      }
    }

    function deleteCurrentChat() {
      if (currentChatType === "public") {
        // Hanya hapus riwayat lokal untuk chat publik
        chatHistory.public = [];
      } else if (currentChatType === "private") {
        // Hapus riwayat chat privat dengan user ini
        if (chatHistory.private[chatWith]) {
          delete chatHistory.private[chatWith];
        }
      } else if (currentChatType === "group") {
        // Hapus riwayat chat grup ini
        const groupName = chatWith.substring(6);
        if (chatHistory.group[groupName]) {
          delete chatHistory.group[groupName];
        }
      }
      
      // Hapus dari Firebase (hanya pesan yang dikirim oleh user ini)
      db.ref("messages").once("value").then(snap => {
        snap.forEach(child => {
          const m = child.val();
          if ((currentChatType === "public" && m.to === "ALL" && m.from === currentUser) ||
              (currentChatType === "private" && 
               ((m.to === chatWith && m.from === currentUser) || 
                (m.from === chatWith && m.to === currentUser))) ||
              (currentChatType === "group" && m.to === chatWith && m.from === currentUser)) {
            db.ref("messages/" + child.key).remove();
          }
        });
      });
      
      displayChatHistory();
      alert("Riwayat chat telah dihapus");
    }

    document.getElementById('btn-send').onclick = sendMessage;

    function sendMessage() {
      const text = chatInput.value.trim();
      if (!text) return;
      
      let recipient = chatWith;
      if (currentChatType === "group") {
        recipient = "GROUP_" + chatWith.substring(6);
      }
      
      const newMessage = {
        from: currentUser, 
        to: recipient, 
        text: text,
        ts: Date.now() 
      };
      
      db.ref("messages").push(newMessage);
      saveMessageToHistory(newMessage);
      chatInput.value = '';
      chatInput.focus();
    }

    document.getElementById('file-input').onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        let content = file.type.startsWith('image') ? `<img src="${reader.result}" width="150">`
                  : file.type.startsWith('video') ? `<video controls width="150"><source src="${reader.result}"></video>`
                  : '';
        
        let recipient = chatWith;
        if (currentChatType === "group") {
          recipient = "GROUP_" + chatWith.substring(6);
        }
        
        const newMessage = {
          from: currentUser, 
          to: recipient, 
          text: content, 
          ts: Date.now() 
        };
        
        db.ref("messages").push(newMessage);
        saveMessageToHistory(newMessage);
      };
      reader.readAsDataURL(file);
    };

    function showMessage({from, to, text, ts}) {
      const d = new Date(ts);
      const time = d.toLocaleTimeString();
      const div = document.createElement('div');
      div.className = "msg " + (from === currentUser ? "you" : "other");
      
      // Tentukan jenis pesan
      let typeLabel = "";
      if (to === "ALL") typeLabel = "[PUBLIK] ";
      else if (to && to.startsWith("GROUP_")) typeLabel = "[GRUP] ";
      else if (from !== currentUser) typeLabel = "[PRIVAT] ";
      
      div.innerHTML = `${typeLabel}<b>${from}</b> @${time}<br>${text}`;
      msgArea.appendChild(div);
      msgArea.scrollTop = msgArea.scrollHeight;
    }

    document.getElementById('btn-create-group').onclick = () => {
      const name = document.getElementById('group-name').value;
      if (!name) return;
      db.ref("groups/" + name).set({ 
        admin: currentUser, 
        members: { [currentUser]: true } 
      });
      alert("Grup dibuat.");
    };

    function inviteToGroup(user) {
      const group = document.getElementById('group-name').value;
      if (!group) return alert("Masukkan nama grup dulu.");
      db.ref("group_requests/" + user + "/" + group).set({ from: currentUser });
      alert("Undangan dikirim.");
    }

    function acceptGroup(group) {
      db.ref("groups/" + group + "/members/" + currentUser).set(true);
      db.ref("group_requests/" + currentUser + "/" + group).remove();
      alert("Bergabung ke grup " + group);
    }

    function switchToGroup() {
      chatBox.style.display = "none";
      groupBox.style.display = "block";
    }

    function switchToChat() {
      chatBox.style.display = "block";
      groupBox.style.display = "none";
    }

    function toggleGroupRequests() {
      groupReqBox.style.display = groupReqBox.style.display === 'none' ? 'block' : 'none';
    }

    window.addEventListener('beforeunload', () => {
      if (currentUser) {
        db.ref("users/" + currentUser).update({ online: false });
      }
    });
  </script>
</body>
</html>